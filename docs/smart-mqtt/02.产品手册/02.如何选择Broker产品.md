---
title: 如何选择Broker产品
date: 2024-12-12 08:36:11
permalink: /smart-mqtt/choose_broker.html
---

如今市面上 MQTT Broker 产品的选择非常多，每款产品都会强调自身在各方面的优势。

丰富多样的宣传点容易给用户在产品选择上造成一定的困扰，本文将结合自身的实践经验，谈谈 MQTT Broker 的选择思路。

## 一、排除干扰项

为了突出卖点，很多产品都在不断的堆砌功能。无论这些功能的实用性如何，反正功能数量就是一种产品优势的体现。

而这些不实用的干扰项，极其容易影响用户的决策判断。此处列举几个例子，局中读者可细品，并作出理性的判断。

### 1.1 规则引擎
MQTT Broker 中的规则引擎，无非是对客户端上报的数据进行基础的过滤、结构化转换、路由分发等。
规则引擎是物联网平台的必要功能，但不该成为 Broker 的特性。

MQTT Broker 只能作为物联网平台的一个核心部件，始终无法完全替代物联网平台的能力。
在 Broker 中配置规则引擎，意味着它已经在承载一定的业务逻辑。
此时的 MQTT Broker 便不再是纯粹的消息中间件，而是与后台业务系统同一性质的存在，需要企业持续投入与业务系统同等的研发资源，直接带来了成本的增加。

从事软件研发的朋友应该都清楚，所有的线上故障都来自人为因素。
在 Broker 中维护规则引擎是一件高风险的行为，它不像业务系统还能做一定的业务隔离、流量管控。
错误的规则一旦生效，可能直接影响全网消息的分发。
MQTT Broker 难以实现精细化的数据治理，这份职责应当由后端的物联网平台来承担更为合适。

尤其当面临服务扩缩容、业务迁移的时候，Broker 中的规则逻辑可能直接影响方案的顺利落地。

当然，并不是说规则引擎在 MQTT Broker 中毫无价值，只是非常有限，个人建议属于业务域的逻辑就统一在业务系统中集中管理，慎用 Broker 自带的规则引擎。

### 1.2 数据桥接功能
数据桥接是 MQTT Broker 将接收到的消息直接写入三方中间件的能力，常见的如：Kafka、Redis、MySQL等。
这类功能的根本目的就是为了**数据持久化**，以及对后台业务提供**削峰填谷**的作用。

**但通过 Broker 桥接至三方中间件，会存在较大的稳定性问题和安全隐患**。

首先，三方中间件通常不是专门服务于 MQTT Broker 的，同时还支持着其他业务。
倘若中间件出现抖动，将直接影响 Broker 的吞吐量，更有甚者还会导致全网 MQTT Client 出现 IO 超时现象。

其次，MQTT Broker 通常是暴露在公网上的服务。
一旦出现账号密码泄露，黑客发起的流量攻击，通过数据桥接功能会直接拖垮中间件，并产生一系列不可预知的连锁反应。

所以，如果是为了数据持久化和削峰填谷的目的，建议在 Broker 与中间件之间有一道专门对数据进行预处理的服务，前文提到的规则引擎能力也适合落在该服务上。

### 1.3 集群
集群算是一项非常有吸引力的特性，这项能力可能直接影响用户的选择。

笔者认为，MQTT Broker的集群功能只是有一定的技术价值，仅此而已，它几乎没什么实用性。

集群在横向扩容方面几乎是无限的。但与此同时，由于所有节点的数据都需要分发到集群中的其他 Broker 节点，流量在内部是会被放大的。
并且随着集群规模的增大，流量也成等比放大，进一步加剧了服务的负载。

什么样的用户会关心集群功能？一定是有着一定设备体量的企业！而单台服务器便可支撑 10 万以上的连接数，试问有多少企业的设备规模达到这种体量。
对于大多数企业，完全没必要去关心一项自身用不上的功能。

即便某家企业的设备规模确实达到数十万，乃至上百万。
结合物联网的行业属性，较少存在终端设备与终端设备直接互联互通的情况，更多都是终端与平台的交互。在这种前提下，负载均衡的架构便可满足需求，同时也具备横向扩缩容能力。

并且出于服务稳定性考虑，分区分域的业务隔离也是一种合适的方案，完全没有必要通过集群来彰显平台的接入能力。

所以，对于 MQTT Broker 宣传的集群能力，各位读者看看就罢了。

::: tip
没有最好的产品，只有最适合的产品。以终为始，基于自身的需求作出理性判断，切莫被这些干扰项误了眼。
:::

## 二、免费开源 or 商业付费
免费白嫖是天性，每个人都乐意通过不花钱的方式解决需求问题。但凡事皆有利弊，大家还需结合自身现状作出合适的选择。

首先谈谈商业付费，这种模式除了要付出一笔资金成本，通常也没什么负面问题。在有一定收入的情况下，厂商才可提供稳定的服务和技术支持，属于互惠互利的关系。


至于免费开源产品，其成产品熟度通常不及商业产品，配套的售后服务也不一定有保障。
但对于绝大多数中小场景的用户，也是能满足需求的。况且都已经免费开源了，还惦记啥自行车。
产品开发者没有义务用自身的时间和精力来做公益，所以遇到问题要么使用者基于开源代码自行解决，要么付出一定成本（付费咨询）享受售后服务。

就目前市面上的几款开源 MQTT Broker，已然能满足大多数用户的需求。所以倘若预算有限，业务体量又不大，可放心选用。

## 三、该如何选择 Broker
这个问题其实很容易得出答案：
作为一款 MQTT Broker，能够支撑的**设备连接量**、**并发吞吐量** 、**安全认证**的能力才是选型时的首要考虑要素。

对于设备连接量才几千、上万的用户，市面上已有的 Broker 产品几乎可以闭眼选。
前期不需要太过纠结哪款产品才是最好的，也不用在乎这款 Broker 是否支持集群，是否支持百万连接。
要清晰的意识到，这个阶段的业务体量，还不配享受这种高级服务。

对于连接量达到十万、甚至百万级的，才是真正难以抉择的阶段。
一方面支持这种体量的免费 Broker 极少；另一方未经实测并无法断定产品的真实能力。

虽然很多产品都号称能够支撑百万级连接，但较少披露这“百万连接”的前提条件。
首先要表明清楚的是单机百万还是集群百万？如果是集群部署，那千万级、亿级也是可行的。

如果能做到单机百万，那确实有一定技术实力了。
这个时候就要关注对于机器配置的要求，如果为了追求单机海量连接，使得硬件成本超过了集群架构的费用，显然也不是一个明智的选择。

最后一点，无论产品宣传的多么好，大家都要以实测的结果为准。是骡子是马，都还得亲自遛一遛。